(()=>{"use strict";function*x(t,n=t.length){for(let i=0;i<t.length;i++)if(1===n)yield[t[i]];else{const e=x([...t.slice(0,i),...t.slice(i+1,t.length)],n-1);for(const l of e)yield[t[i],...l]}}const S=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"];function E(t,n){const i=Object.assign({},t);return n.forEach(([e,l])=>{i[e]||(i[e]=0),i[e]+=l}),i}function A(t,n,i,e,l,s){const f=S.filter(o=>!s.allowedPenalties.includes(o)),u=Object.fromEntries([i.stonePenalty]),d=function(t,n){return Array.from({length:n},(i,e)=>{let l=0;for(let s=e;s<n-1;s+=1)l+=t[s+1][0].price;return l})}(t,n.length);function m(o){return f.find(c=>{var a;return o[c]>=5*Math.floor((null!==(a=u[c])&&void 0!==a?a:0)/5+1)})}const r=n.length;return function p(o,c,a,g){if(g===r)return function(o){return Object.keys(s.effects).find(c=>o[c]<s.effects[c])}(o)||s.ancientCountMin>0&&Object.values(a).filter(b=>6===b.grade).length<s.ancientCountMin?[]:[{effects:o,price:c,items:Object.assign({},a),stoneBook:i}];const O=[],h=t[g],y=n[g],j=d[g];for(const b of h){if(c+b.price+j>l)continue;const v=E(o,b.effects);m(v)||(a[y]=b,O.push(...p(v,c+b.price,a,g+1)),delete a[y])}return O}(Object.values(e).reduce((o,c)=>E(o,c.effects),u),0,e,0)}function R(t){return JSON.stringify(Object.values(t.items).sort((n,i)=>n.name.localeCompare(i.name)))}function C(t,n){return t.filter(e=>e.isFixed||!function(e){return e.grade<5||!!n.hasBuyPrice&&!e.buyPrice||e.tradeLeft<n.tradeLeft||n.exclude.has(e.id)}(e))}function $(t,n,i,e,l){let s=Array.from(x(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(r=>!e[r])));const f=function(t){return{\uadc0\uac78\uc774:JSON.stringify(t.\uadc0\uac78\uc7741)===JSON.stringify(t.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(t.\ubc18\uc9c01)===JSON.stringify(t.\ubc18\uc9c02)}}(n);f.\uadc0\uac78\uc774&&(s=s.filter(r=>r.findIndex(c=>"\uadc0\uac78\uc7741"===c)<r.findIndex(c=>"\uadc0\uac78\uc7742"===c))),f.\ubc18\uc9c0&&(s=s.filter(r=>r.findIndex(c=>"\ubc18\uc9c01"===c)<r.findIndex(c=>"\ubc18\uc9c02"===c)));const u=s.length*t.flatMap(r=>r.combinations).length,d=Object.fromEntries(Object.entries(i).map(([r,p])=>[r,C(p,l)]));let m=0;const P=new Map;for(const{combinations:r,stoneBook:p}of t){let o=[];for(const c of r)for(const a of s){const g=[];for(let O=0;O<a.length;O+=1){const h=a[O],y=Object.entries(c[O]),j=d[`${y[0][0]}_${y[0][1]}_${y[1][0]}_${y[1][1]}_${h}`].sort((b,v)=>b.price-v.price);j.length>0&&g.push(j)}if(g.length===a.length){o.push(...A(g,a,p,e,o.length?o[o.length-1].price:1/0,l));const O={};o.forEach(h=>{O[R(h)]=h}),o=Object.values(O),o.sort((h,y)=>h.price-y.price),o=o.slice(0,300)}m+=1,postMessage({done:!1,total:u,finished:m})}P.set(p,o)}postMessage({done:!0,result:[...P.values()].flat().sort((r,p)=>r.price-p.price)})}addEventListener("message",({data:t})=>{$(t.candidates,t.accMap,t.searchResult,t.fixedItems,t.filter)})})();