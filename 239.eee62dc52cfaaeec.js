(()=>{"use strict";function*x(n,t=n.length){for(let i=0;i<n.length;i++)if(1===t)yield[n[i]];else{const e=x([...n.slice(0,i),...n.slice(i+1,n.length)],t-1);for(const s of e)yield[n[i],...s]}}const q=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"];function _(n,t){const i=Object.assign({},n);return t.forEach(([e,s])=>{i[e]||(i[e]=0),i[e]+=s}),i}function R(n,t,i,e,s,o){const P=q.filter(r=>!o.allowedPenalties.includes(r)),d=Object.fromEntries([i.stonePenalty]),y=function(n,t){return Array.from({length:t},(i,e)=>{let s=0;for(let o=e;o<t-1;o+=1)s+=n[o+1][0].price;return s})}(n,t.length);function b(r){return P.find(c=>{var a;return r[c]>=5*Math.floor((null!==(a=d[c])&&void 0!==a?a:0)/5+1)})}const l=t.length;return function f(r,c,a,g,u){if(u===l)return function(r){return Object.keys(o.effects).find(c=>r[c]<o.effects[c])}(r)||o.ancientCountMin>0&&Object.values(g).filter(p=>6===p.grade).length<o.ancientCountMin?[]:[{effects:r,price:c,items:Object.assign({},g),stoneBook:i}];const m=[],h=n[u],j=t[u],v=y[u];for(const p of h){if(a.has(p.name)||c+p.price+v>s)continue;const E=_(r,p.effects);b(E)||(a.add(p.name),g[j]=p,m.push(...f(E,c+p.price,a,g,u+1)),a.delete(p.name),delete g[j])}return m}(Object.values(e).reduce((r,c)=>_(r,c.effects),d),0,new Set(Object.values(e).map(r=>r.name)),e,0)}function w(n){return JSON.stringify(Object.values(n.items).sort((t,i)=>t.name.localeCompare(i.name)))}function C(n,t){return n.filter(e=>e.isFixed||!function(e){return e.grade<5||!!t.hasBuyPrice&&!e.buyPrice||e.tradeLeft<t.tradeLeft||t.exclude.has(e.id)}(e))}function I(n,t,i,e,s){let o=Array.from(x(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(l=>!e[l])));const P=function(n){return{\uadc0\uac78\uc774:JSON.stringify(n.\uadc0\uac78\uc7741)===JSON.stringify(n.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(n.\ubc18\uc9c01)===JSON.stringify(n.\ubc18\uc9c02)}}(t);P.\uadc0\uac78\uc774&&(o=o.filter(l=>l.findIndex(c=>"\uadc0\uac78\uc7741"===c)<l.findIndex(c=>"\uadc0\uac78\uc7742"===c))),P.\ubc18\uc9c0&&(o=o.filter(l=>l.findIndex(c=>"\ubc18\uc9c01"===c)<l.findIndex(c=>"\ubc18\uc9c02"===c)));const d=o.length*n.flatMap(l=>l.combinations).length,y=Object.fromEntries(Object.entries(i).map(([l,f])=>[l,C(f,s)]));let b=0;const O=new Map;for(const{combinations:l,stoneBook:f}of n){let r=[];for(const c of l)for(const a of o){const g=[];for(let u=0;u<a.length;u+=1){const m=a[u],h=Object.entries(c[u]),j=y[`${h[0][0]}_${h[0][1]}_${h[1][0]}_${h[1][1]}_${m}`].sort((v,p)=>v.price-p.price);j.length>0&&g.push(j)}if(g.length===a.length){r.push(...R(g,a,f,e,r.length?r[r.length-1].price:1/0,s));const u={};r.forEach(m=>{u[w(m)]=m}),r=Object.values(u),r.sort((m,h)=>m.price-h.price),r=r.slice(0,300)}b+=1,postMessage({done:!1,total:d,finished:b})}O.set(f,r)}postMessage({done:!0,result:[...O.values()].flat().sort((l,f)=>l.price-f.price)})}addEventListener("message",({data:n})=>{I(n.candidates,n.accMap,n.searchResult,n.fixedItems,n.filter)})})();