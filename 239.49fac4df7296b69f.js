(()=>{"use strict";function*E(n,e=n.length){for(let t=0;t<n.length;t++)if(1===e)yield[n[t]];else{const f=E([...n.slice(0,t),...n.slice(t+1,n.length)],e-1);for(const i of f)yield[n[t],...i]}}const v=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"],q=["\uce58\uba85","\ud2b9\ud654","\uc81c\uc555","\uc2e0\uc18d","\uc778\ub0b4","\uc219\ub828"];function _(n,e){const t=Object.assign({},n);return e.forEach(([f,i])=>{t[f]||(t[f]=0),t[f]+=i}),t}function R(n,e,t,f,i,o){const O=v.filter(r=>!o.allowedPenalties.includes(r)),m=Object.fromEntries([t.stonePenalty]),P=function(n,e){return Array.from({length:e},(t,f)=>{let i=0;for(let o=f;o<e-1;o+=1)i+=n[o+1][0].price;return i})}(n,e.length);function b(r){return O.find(s=>{var u;return r[s]>=5*Math.floor((null!==(u=m[s])&&void 0!==u?u:0)/5+1)})}const c=e.length;return function l(r,s,u,y,p){if(p===c)return function(r){return Object.keys(o.effects).find(s=>r[s]<o.effects[s])}(r)?[]:[{effects:r,price:s,items:Object.assign({},y),stoneBook:t}];const d=[],h=n[p],j=e[p],x=P[p];for(const g of h){if(u.has(g.name)||s+g.price+x>i)continue;const S=_(r,g.effects);b(S)||(u.add(g.name),y[j]=g,d.push(...l(S,s+g.price,u,y,p+1)),u.delete(g.name),delete y[j])}return d}(Object.values(f).reduce((r,s)=>_(r,s.effects),m),0,new Set(Object.values(f).map(r=>r.name)),f,0)}function $(n){return JSON.stringify(Object.values(n.items).sort((e,t)=>e.name.localeCompare(t.name)))}function F(n,e){return n.filter((i,o)=>!(function(i){return i.grade<5||!!e.hasBuyPrice&&!i.buyPrice||i.tradeLeft<e.tradeLeft||e.exclude.has(i.id)}(i)||n.find((O,m)=>o!==m&&function(i,o){const[O,m]=i.effects.find(([a])=>v.includes(a)),[P,b]=o.effects.find(([a])=>v.includes(a));return i.name===o.name&&i.grade===o.grade&&i.price<=o.price&&i.tradeLeft>=o.tradeLeft&&O===P&&m<=b&&q.map(a=>[i.effects.find(([c])=>c===a),o.effects.find(([c])=>c===a)]).filter(([a,c])=>a&&c).every(([a,c])=>a[1]>=c[1])}(O,i))))}function L(n,e,t,f,i){let o=Array.from(E(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(c=>!f[c])));const O=function(n){return{\uadc0\uac78\uc774:JSON.stringify(n.\uadc0\uac78\uc7741)===JSON.stringify(n.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(n.\ubc18\uc9c01)===JSON.stringify(n.\ubc18\uc9c02)}}(e);O.\uadc0\uac78\uc774&&(o=o.filter(c=>c.findIndex(s=>"\uadc0\uac78\uc7741"===s)<c.findIndex(s=>"\uadc0\uac78\uc7742"===s))),O.\ubc18\uc9c0&&(o=o.filter(c=>c.findIndex(s=>"\ubc18\uc9c01"===s)<c.findIndex(s=>"\ubc18\uc9c02"===s)));const m=o.length*n.flatMap(c=>c.combinations).length,P=Object.fromEntries(Object.entries(t).map(([c,l])=>[c,F(l,i)]));let b=0;const a=new Map;for(const{combinations:c,stoneBook:l}of n){let r=[];for(const s of c)for(const u of o){const y=[];for(let p=0;p<u.length;p+=1){const d=u[p],h=Object.entries(s[p]),j=P[`${h[0][0]}_${h[0][1]}_${h[1][0]}_${h[1][1]}_${d}`].sort((x,g)=>x.price-g.price);j.length>0&&y.push(j)}if(y.length===u.length){r.push(...R(y,u,l,f,r.length?r[r.length-1].price:1/0,i));const p={};r.forEach(d=>{p[$(d)]=d}),r=Object.values(p),r.sort((d,h)=>d.price-h.price),r=r.slice(0,300)}b+=1,postMessage({done:!1,total:m,finished:b})}a.set(l,r)}postMessage({done:!0,result:[...a.values()].flat().sort((c,l)=>c.price-l.price)})}addEventListener("message",({data:n})=>{L(n.candidates,n.accMap,n.searchResult,n.fixedItems,n.filter)})})();