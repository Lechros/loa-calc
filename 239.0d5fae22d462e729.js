(()=>{"use strict";function*v(n,t=n.length){for(let i=0;i<n.length;i++)if(1===t)yield[n[i]];else{const e=v([...n.slice(0,i),...n.slice(i+1,n.length)],t-1);for(const c of e)yield[n[i],...c]}}const F=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"];function x(n,t){const i=Object.assign({},n);return t.forEach(([e,c])=>{i[e]||(i[e]=0),i[e]+=c}),i}function A(n,t,i,e,c,l){const a=F.filter(r=>!l.allowedPenalties.includes(r)),d=Object.fromEntries([i.stonePenalty]),y=function(n,t){return Array.from({length:t},(i,e)=>{let c=0;for(let l=e;l<t-1;l+=1)c+=n[l+1][0].price;return c})}(n,t.length);function b(r){return a.find(s=>{var u;return r[s]>=5*Math.floor((null!==(u=d[s])&&void 0!==u?u:0)/5+1)})}const o=t.length;return function f(r,s,u,O,p){if(p===o)return function(r){return Object.keys(l.effects).find(s=>r[s]<l.effects[s])}(r)||l.ancientCountMin>0&&Object.values(O).filter(g=>6===g.grade).length<l.ancientCountMin?[]:[{effects:r,price:s,items:Object.assign({},O),stoneBook:i}];const h=[],m=n[p],S=t[p],j=y[p];for(const g of m){if(u.has(g.id)||s+g.price+j>c)continue;const _=x(r,g.effects);b(_)||(u.add(g.id),O[S]=g,h.push(...f(_,s+g.price,u,O,p+1)),u.delete(g.id),delete O[S])}return h}(Object.values(e).reduce((r,s)=>x(r,s.effects),d),0,new Set(Object.values(e).map(r=>r.id)),e,0)}function R(n){return JSON.stringify(Object.values(n.items).sort((t,i)=>t.name.localeCompare(i.name)))}function $(n,t){return n.filter(e=>e.isFixed||!function(e){return e.grade<5||!!t.hasBuyPrice&&!e.buyPrice||e.tradeLeft<t.tradeLeft||t.exclude.has(e.id)}(e))}function L(n){return{id:String.fromCharCode(Math.floor(26*Math.random())+97)+Math.random().toString(16).slice(2)+Date.now().toString(16).slice(4),name:"\uc81c\uc678\ub41c \uc2ac\ub86f",price:0,grade:0,tradeLeft:0,isFixed:!0,effects:n,buyPrice:0,auctionPrice:0,quality:0}}function D(n,t,i,e,c){let l=Array.from(v(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(o=>!e[o])));const a=function(n){return{\uadc0\uac78\uc774:JSON.stringify(n.\uadc0\uac78\uc7741)===JSON.stringify(n.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(n.\ubc18\uc9c01)===JSON.stringify(n.\ubc18\uc9c02)}}(t);a.\uadc0\uac78\uc774&&!(c.ignoredSlots.includes("\uadc0\uac78\uc7741")||c.ignoredSlots.includes("\uadc0\uac78\uc7742"))&&(l=l.filter(o=>o.findIndex(s=>"\uadc0\uac78\uc7741"===s)<o.findIndex(s=>"\uadc0\uac78\uc7742"===s))),a.\ubc18\uc9c0&&!c.ignoredSlots.includes("\ubc18\uc9c01")&&!c.ignoredSlots.includes("\ubc18\uc9c02")&&(l=l.filter(o=>o.findIndex(s=>"\ubc18\uc9c01"===s)<o.findIndex(s=>"\ubc18\uc9c02"===s)));const d=l.length*n.flatMap(o=>o.combinations).length,y=Object.fromEntries(Object.entries(i).map(([o,f])=>[o,$(f,c)]));let b=0;const P=new Map;for(const{combinations:o,stoneBook:f}of n){let r=[];for(const s of o)for(const u of l){const O=[];for(let p=0;p<u.length;p+=1){const h=u[p],m=Object.entries(s[p]);if(c.ignoredSlots.includes(h)){if(c.fixedImprintings.includes(m[0][0])||c.fixedImprintings.includes(m[1][0]))continue;O.push([L(m)]);continue}const S=y[`${m[0][0]}_${m[0][1]}_${m[1][0]}_${m[1][1]}_${h}`].sort((j,g)=>j.price-g.price);S.length>0&&O.push(S)}if(O.length===u.length){r.push(...A(O,u,f,e,r.length?r[r.length-1].price:1/0,c));const p={};r.forEach(h=>{p[R(h)]=h}),r=Object.values(p),r.sort((h,m)=>h.price-m.price),r=r.slice(0,300)}b+=1,postMessage({done:!1,total:d,finished:b})}P.set(f,r)}postMessage({done:!0,result:[...P.values()].flat().sort((o,f)=>o.price-f.price)})}addEventListener("message",({data:n})=>{D(n.candidates,n.accMap,n.searchResult,n.fixedItems,n.filter)})})();