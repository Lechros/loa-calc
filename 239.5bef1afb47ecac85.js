(()=>{"use strict";function*E(n,e=n.length){for(let t=0;t<n.length;t++)if(1===e)yield[n[t]];else{const s=E([...n.slice(0,t),...n.slice(t+1,n.length)],e-1);for(const i of s)yield[n[t],...i]}}const v=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"],q=["\uce58\uba85","\ud2b9\ud654","\uc81c\uc555","\uc2e0\uc18d","\uc778\ub0b4","\uc219\ub828"];function _(n,e){const t=Object.assign({},n);return e.forEach(([s,i])=>{t[s]||(t[s]=0),t[s]+=i}),t}function R(n,e,t,s,i,o){const m=v.filter(r=>!o.allowedPenalties.includes(r)),O=Object.fromEntries([t.stonePenalty]),P=function(n,e){return Array.from({length:e},(t,s)=>{let i=0;for(let o=s;o<e-1;o+=1)i+=n[o+1][0].price;return i})}(n,e.length);function b(r){return m.find(f=>{var u;return r[f]>=5*Math.floor((null!==(u=O[f])&&void 0!==u?u:0)/5+1)})}const c=e.length;return function l(r,f,u,y,p){if(p===c)return function(r){return Object.keys(o.effects).find(f=>r[f]<o.effects[f])}(r)?[]:[{effects:r,price:f,items:Object.assign({},y),stoneBook:t}];const d=[],h=n[p],j=e[p],x=P[p];for(const g of h){if(u.has(g.name)||f+g.price+x>i)continue;const S=_(r,g.effects);b(S)||(u.add(g.name),y[j]=g,d.push(...l(S,f+g.price,u,y,p+1)),u.delete(g.name),delete y[j])}return d}(Object.values(s).reduce((r,f)=>_(r,f.effects),O),0,new Set(Object.values(s).map(r=>r.name)),s,0)}function $(n){return JSON.stringify(Object.values(n.items).sort((e,t)=>e.name.localeCompare(t.name)))}function F(n,e){return n.filter(i=>!function(i){return i.grade<5||!!e.hasBuyPrice&&!i.buyPrice||i.tradeLeft<e.tradeLeft||e.exclude.has(i.id)}(i)).filter((i,o)=>!n.find((m,O)=>o!==O&&function(i,o){const[m,O]=i.effects.find(([a])=>v.includes(a)),[P,b]=o.effects.find(([a])=>v.includes(a));return i.name===o.name&&i.grade===o.grade&&i.price<=o.price&&i.tradeLeft>=o.tradeLeft&&m===P&&O<=b&&q.map(a=>[i.effects.find(([c])=>c===a),o.effects.find(([c])=>c===a)]).filter(([a,c])=>a&&c).every(([a,c])=>a[1]>=c[1])}(m,i)))}function L(n,e,t,s,i){let o=Array.from(E(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(c=>!s[c])));const m=function(n){return{\uadc0\uac78\uc774:JSON.stringify(n.\uadc0\uac78\uc7741)===JSON.stringify(n.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(n.\ubc18\uc9c01)===JSON.stringify(n.\ubc18\uc9c02)}}(e);m.\uadc0\uac78\uc774&&(o=o.filter(c=>c.findIndex(f=>"\uadc0\uac78\uc7741"===f)<c.findIndex(f=>"\uadc0\uac78\uc7742"===f))),m.\ubc18\uc9c0&&(o=o.filter(c=>c.findIndex(f=>"\ubc18\uc9c01"===f)<c.findIndex(f=>"\ubc18\uc9c02"===f)));const O=o.length*n.flatMap(c=>c.combinations).length,P=Object.fromEntries(Object.entries(t).map(([c,l])=>[c,F(l,i)]));let b=0;const a=new Map;for(const{combinations:c,stoneBook:l}of n){let r=[];for(const f of c)for(const u of o){const y=[];for(let p=0;p<u.length;p+=1){const d=u[p],h=Object.entries(f[p]),j=P[`${h[0][0]}_${h[0][1]}_${h[1][0]}_${h[1][1]}_${d}`].sort((x,g)=>x.price-g.price);j.length>0&&y.push(j)}if(y.length===u.length){r.push(...R(y,u,l,s,r.length?r[r.length-1].price:1/0,i));const p={};r.forEach(d=>{p[$(d)]=d}),r=Object.values(p),r.sort((d,h)=>d.price-h.price),r=r.slice(0,300)}b+=1,postMessage({done:!1,total:O,finished:b})}a.set(l,r)}postMessage({done:!0,result:[...a.values()].flat().sort((c,l)=>c.price-l.price)})}addEventListener("message",({data:n})=>{L(n.candidates,n.accMap,n.searchResult,n.fixedItems,n.filter)})})();