(()=>{"use strict";function*E(n,e=n.length){for(let t=0;t<n.length;t++)if(1===e)yield[n[t]];else{const c=E([...n.slice(0,t),...n.slice(t+1,n.length)],e-1);for(const a of c)yield[n[t],...a]}}const v=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"],q=["\uce58\uba85","\ud2b9\ud654","\uc81c\uc555","\uc2e0\uc18d","\uc778\ub0b4","\uc219\ub828"];function _(n,e){const t=Object.assign({},n);return e.forEach(([c,a])=>{t[c]||(t[c]=0),t[c]+=a}),t}function C(n,e,t,c,a,i){const l=v.filter(o=>!i.allowedPenalties.includes(o)),m=Object.fromEntries([t.stonePenalty]),h=function(n,e){return Array.from({length:e},(t,c)=>{let a=0;for(let i=c;i<e-1;i+=1)a+=n[i+1][0].price;return a})}(n,e.length);function b(o){return l.find(f=>{var u;return o[f]>=5*Math.floor((null!==(u=m[f])&&void 0!==u?u:0)/5+1)})}const r=e.length;return function s(o,f,u,g,p){if(p===r)return function(o){return Object.keys(i.effects).find(f=>o[f]<i.effects[f])}(o)||i.ancientCountMin>0&&Object.values(g).filter(d=>6===d.grade).length<i.ancientCountMin?[]:[{effects:o,price:f,items:Object.assign({},g),stoneBook:t}];const O=[],y=n[p],j=e[p],x=h[p];for(const d of y){if(u.has(d.name)||f+d.price+x>a)continue;const M=_(o,d.effects);b(M)||(u.add(d.name),g[j]=d,O.push(...s(M,f+d.price,u,g,p+1)),u.delete(d.name),delete g[j])}return O}(Object.values(c).reduce((o,f)=>_(o,f.effects),m),0,new Set(Object.values(c).map(o=>o.name)),c,0)}function R(n){return JSON.stringify(Object.values(n.items).sort((e,t)=>e.name.localeCompare(t.name)))}function $(n,e){const a=n.filter(i=>!function(i){return i.grade<5||!!e.hasBuyPrice&&!i.buyPrice||i.tradeLeft<e.tradeLeft||e.exclude.has(i.id)}(i));return a.filter((i,l)=>!a.find((m,h)=>l!==h&&function(i,l){const[m,h]=i.effects.find(([r])=>v.includes(r)),[b,P]=l.effects.find(([r])=>v.includes(r));return i.name===l.name&&i.grade===l.grade&&i.price<=l.price&&i.tradeLeft>=l.tradeLeft&&m===b&&h<=P&&q.map(r=>[i.effects.find(([s])=>s===r),l.effects.find(([s])=>s===r)]).filter(([r,s])=>r&&s).every(([r,s])=>r[1]>=s[1])}(m,i)))}function F(n,e,t,c,a){let i=Array.from(E(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(r=>!c[r])));const l=function(n){return{\uadc0\uac78\uc774:JSON.stringify(n.\uadc0\uac78\uc7741)===JSON.stringify(n.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(n.\ubc18\uc9c01)===JSON.stringify(n.\ubc18\uc9c02)}}(e);l.\uadc0\uac78\uc774&&(i=i.filter(r=>r.findIndex(f=>"\uadc0\uac78\uc7741"===f)<r.findIndex(f=>"\uadc0\uac78\uc7742"===f))),l.\ubc18\uc9c0&&(i=i.filter(r=>r.findIndex(f=>"\ubc18\uc9c01"===f)<r.findIndex(f=>"\ubc18\uc9c02"===f)));const m=i.length*n.flatMap(r=>r.combinations).length,h=Object.fromEntries(Object.entries(t).map(([r,s])=>[r,$(s,a)]));let b=0;const P=new Map;for(const{combinations:r,stoneBook:s}of n){let o=[];for(const f of r)for(const u of i){const g=[];for(let p=0;p<u.length;p+=1){const O=u[p],y=Object.entries(f[p]),j=h[`${y[0][0]}_${y[0][1]}_${y[1][0]}_${y[1][1]}_${O}`].sort((x,d)=>x.price-d.price);j.length>0&&g.push(j)}if(g.length===u.length){o.push(...C(g,u,s,c,o.length?o[o.length-1].price:1/0,a));const p={};o.forEach(O=>{p[R(O)]=O}),o=Object.values(p),o.sort((O,y)=>O.price-y.price),o=o.slice(0,300)}b+=1,postMessage({done:!1,total:m,finished:b})}P.set(s,o)}postMessage({done:!0,result:[...P.values()].flat().sort((r,s)=>r.price-s.price)})}addEventListener("message",({data:n})=>{F(n.candidates,n.accMap,n.searchResult,n.fixedItems,n.filter)})})();