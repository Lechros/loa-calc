(()=>{"use strict";function*E(t,e=t.length){for(let n=0;n<t.length;n++)if(1===e)yield[t[n]];else{const c=E([...t.slice(0,n),...t.slice(n+1,t.length)],e-1);for(const a of c)yield[t[n],...a]}}const v=["\uacf5\uaca9\ub825 \uac10\uc18c","\uacf5\uaca9\uc18d\ub3c4 \uac10\uc18c","\ubc29\uc5b4\ub825 \uac10\uc18c","\uc774\ub3d9\uc18d\ub3c4 \uac10\uc18c"],q=["\uce58\uba85","\ud2b9\ud654","\uc81c\uc555","\uc2e0\uc18d","\uc778\ub0b4","\uc219\ub828"];function _(t,e){const n=Object.assign({},t);return e.forEach(([c,a])=>{n[c]||(n[c]=0),n[c]+=a}),n}function R(t,e,n,c,a,i){const l=v.filter(o=>!i.allowedPenalties.includes(o)),m=Object.fromEntries([n.stonePenalty]),h=function(t,e){return Array.from({length:e},(n,c)=>{let a=0;for(let i=c;i<e-1;i+=1)a+=t[i+1][0].price;return a})}(t,e.length);function b(o){return l.find(f=>{var u;return o[f]>=5*Math.floor((null!==(u=m[f])&&void 0!==u?u:0)/5+1)})}const r=e.length;return function s(o,f,u,O,p){if(p===r)return function(o){return Object.keys(i.effects).find(f=>o[f]<i.effects[f])}(o)?[]:[{effects:o,price:f,items:Object.assign({},O),stoneBook:n}];const d=[],y=t[p],j=e[p],x=h[p];for(const g of y){if(u.has(g.name)||f+g.price+x>a)continue;const S=_(o,g.effects);b(S)||(u.add(g.name),O[j]=g,d.push(...s(S,f+g.price,u,O,p+1)),u.delete(g.name),delete O[j])}return d}(Object.values(c).reduce((o,f)=>_(o,f.effects),m),0,new Set(Object.values(c).map(o=>o.name)),c,0)}function $(t){return JSON.stringify(Object.values(t.items).sort((e,n)=>e.name.localeCompare(n.name)))}function F(t,e){const a=t.filter(i=>!function(i){return i.grade<5||!!e.hasBuyPrice&&!i.buyPrice||i.tradeLeft<e.tradeLeft||e.exclude.has(i.id)}(i));return a.filter((i,l)=>!a.find((m,h)=>l!==h&&function(i,l){const[m,h]=i.effects.find(([r])=>v.includes(r)),[b,P]=l.effects.find(([r])=>v.includes(r));return i.name===l.name&&i.grade===l.grade&&i.price<=l.price&&i.tradeLeft>=l.tradeLeft&&m===b&&h<=P&&q.map(r=>[i.effects.find(([s])=>s===r),l.effects.find(([s])=>s===r)]).filter(([r,s])=>r&&s).every(([r,s])=>r[1]>=s[1])}(m,i)))}function L(t,e,n,c,a){let i=Array.from(E(["\ubaa9\uac78\uc774","\uadc0\uac78\uc7741","\uadc0\uac78\uc7742","\ubc18\uc9c01","\ubc18\uc9c02"].filter(r=>!c[r])));const l=function(t){return{\uadc0\uac78\uc774:JSON.stringify(t.\uadc0\uac78\uc7741)===JSON.stringify(t.\uadc0\uac78\uc7742),\ubc18\uc9c0:JSON.stringify(t.\ubc18\uc9c01)===JSON.stringify(t.\ubc18\uc9c02)}}(e);l.\uadc0\uac78\uc774&&(i=i.filter(r=>r.findIndex(f=>"\uadc0\uac78\uc7741"===f)<r.findIndex(f=>"\uadc0\uac78\uc7742"===f))),l.\ubc18\uc9c0&&(i=i.filter(r=>r.findIndex(f=>"\ubc18\uc9c01"===f)<r.findIndex(f=>"\ubc18\uc9c02"===f)));const m=i.length*t.flatMap(r=>r.combinations).length,h=Object.fromEntries(Object.entries(n).map(([r,s])=>[r,F(s,a)]));let b=0;const P=new Map;for(const{combinations:r,stoneBook:s}of t){let o=[];for(const f of r)for(const u of i){const O=[];for(let p=0;p<u.length;p+=1){const d=u[p],y=Object.entries(f[p]),j=h[`${y[0][0]}_${y[0][1]}_${y[1][0]}_${y[1][1]}_${d}`].sort((x,g)=>x.price-g.price);j.length>0&&O.push(j)}if(O.length===u.length){o.push(...R(O,u,s,c,o.length?o[o.length-1].price:1/0,a));const p={};o.forEach(d=>{p[$(d)]=d}),o=Object.values(p),o.sort((d,y)=>d.price-y.price),o=o.slice(0,300)}b+=1,postMessage({done:!1,total:m,finished:b})}P.set(s,o)}postMessage({done:!0,result:[...P.values()].flat().sort((r,s)=>r.price-s.price)})}addEventListener("message",({data:t})=>{L(t.candidates,t.accMap,t.searchResult,t.fixedItems,t.filter)})})();